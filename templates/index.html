{% extends 'base.html' %}

{% block container %}

    <h2>Welcome to Your Budget Tracker!</h2>
    <p>Empower users to plan and track spending on mobile quickly and clearly!</p>

    <!---Monthly Budget Overview-->

        <!-- Monthly Budget Overview Card -->
        <section id="monthly-budget-overview" style="margin:12px 0;">
            <h3>Monthly Budget Overview</h3>
            <div id="monthlyBudgetCard" style="border:1px solid #ccc; padding:12px; max-width:520px; position:relative;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button id="mb-prev" aria-label="Previous month">◀ Prev</button>
                        <input type="month" id="mb-select-month" aria-label="Select month" />
                        <button id="mb-next" aria-label="Next month">Next ▶</button>
                        <p id="mb-monthyear" style="margin:0 0 8px 0; font-weight:600; color:#333;"></p>
                    </div>
                    <div id="mb-actions" style="display:none;">
                        <a id="mb-edit-link" href="#" style="margin-right:8px;">
                            <button id="mb-edit-btn" aria-label="Edit monthly budget">Edit</button>
                        </a>
                        <a id="mb-delete-link" href="#" onclick="return confirm('Are you sure you want to delete this monthly budget?');">
                            <button id="mb-delete-btn" aria-label="Delete monthly budget" style="background:#dc3545; color:white; border:1px solid #dc3545;">Delete</button>
                        </a>
                    </div>
                </div>
                <div id="mb-loading">Loading monthly summary...</div>

                <div id="mb-content" style="display:none;">
                    <p><strong>Budget:</strong> $<span id="mb-budget">0.00</span></p>
                    <p><strong>Spent:</strong> $<span id="mb-spent">0.00</span></p>
                    <p><strong>Planned:</strong> $<span id="mb-planned">0.00</span></p>
                    <p><strong>Remaining:</strong> $<span id="mb-remaining">0.00</span></p>
                </div>

                <div id="mb-no-budget" style="display:none; text-align:center; padding:20px 0;">
                    <p id="mb-no-budget-text" style="color:#666; margin-bottom:12px;">No monthly budget set for <span id="mb-no-monthyear"></span>.</p>
                    <a id="mb-add-link" href="{{ url_for('add_monthly_budget') }}"><button>New Monthly Budget</button></a>
                </div>
            </div>
        </section>

        <!-- Placeholders for charts (future) -->
        <!-- Add line chart for expenses over time here -->
        <!-- Add pie chart for expenses by category here -->

        <script>
            (function(){
                // Fetch budget summary for current month/year and populate the card
                const now = new Date();
                const month = now.getMonth() + 1; // JS months are 0-based
                const year = now.getFullYear();
                const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
                const monthYearEl = document.getElementById('mb-monthyear');
                if (monthYearEl) monthYearEl.textContent = `${monthNames[now.getMonth()]} ${year}`;
                // also update the no-budget message month/year span
                const nobudgetMonthYear = document.getElementById('mb-no-monthyear');
                if (nobudgetMonthYear) nobudgetMonthYear.textContent = `${monthNames[now.getMonth()]} ${year}`;
                // Add cache-busting timestamp to force fresh data
                const loading = document.getElementById('mb-loading');
                const content = document.getElementById('mb-content');
                const nobudget = document.getElementById('mb-no-budget');
                const addLink = document.getElementById('mb-add-link');
                const editLink = document.getElementById('mb-edit-link');
                const deleteLink = document.getElementById('mb-delete-link');
                const actionsDiv = document.getElementById('mb-actions');

                // month picker element
                const monthPicker = document.getElementById('mb-select-month');
                const prevBtn = document.getElementById('mb-prev');
                const nextBtn = document.getElementById('mb-next');

                // set max for monthPicker to current month to disable future months in browser UI
                if (monthPicker) {
                    const nowForMax = new Date();
                    const maxVal = `${nowForMax.getFullYear()}-${String(nowForMax.getMonth()+1).padStart(2,'0')}`;
                    monthPicker.setAttribute('max', maxVal);
                }

                function setAddLink(m, y){
                    if (addLink) addLink.href = `/monthly_budget/add?month=${m}&year=${y}`;
                }

                function formatMonthPickerValue(y, m){
                    return `${String(y).padStart(4,'0')}-${String(m).padStart(2,'0')}`;
                }

                async function loadMonth(y, m){
                    // update visible month/year labels and add link
                    if (monthYearEl) monthYearEl.textContent = `${monthNames[m-1]} ${y}`;
                    const nobudgetMonthYear = document.getElementById('mb-no-monthyear');
                    if (nobudgetMonthYear) nobudgetMonthYear.textContent = `${monthNames[m-1]} ${y}`;
                    if (monthPicker) monthPicker.value = formatMonthPickerValue(y, m);
                    setAddLink(m, y);

                    loading.style.display = 'block';
                    content.style.display = 'none';
                    nobudget.style.display = 'none';
                    // hide action buttons until we know there is a budget
                    if (actionsDiv) actionsDiv.style.display = 'none';
                    if (editLink) editLink.href = '#';
                    if (deleteLink) deleteLink.href = '#';

                    const url = `/budget/summary/${m}/${y}?_=${Date.now()}`;
                    try {
                        const res = await fetch(url);
                        if (!res.ok) {
                            loading.style.display = 'none';
                            nobudget.style.display = 'block';
                            if (actionsDiv) actionsDiv.style.display = 'none';
                            return;
                        }

                        const j = await res.json();
                        const budget = j.budget ?? null;
                        if (budget === null) {
                            loading.style.display = 'none';
                            nobudget.style.display = 'block';
                            if (actionsDiv) actionsDiv.style.display = 'none';
                            return;
                        }

                        const spent = j.spent ?? 0;
                        const planned = j.planned ?? 0;
                        const remaining = (j.remaining_budget !== undefined && j.remaining_budget !== null)
                                            ? j.remaining_budget
                                            : (budget - spent);

                        loading.style.display = 'none';
                        content.style.display = 'block';

                        document.getElementById('mb-budget').textContent = Number(budget).toFixed(2);
                        document.getElementById('mb-spent').textContent = Number(spent).toFixed(2);
                        document.getElementById('mb-planned').textContent = Number(planned).toFixed(2);
                        document.getElementById('mb-remaining').textContent = Number(remaining).toFixed(2);

                        // try to wire up edit/delete links
                        const editLink = document.getElementById('mb-edit-link');
                        const deleteLink = document.getElementById('mb-delete-link');
                        const actionsDiv = document.getElementById('mb-actions');
                        if (j.budget_id && editLink && deleteLink) {
                            editLink.href = `/monthly_budget/edit/${j.budget_id}`;
                            deleteLink.href = `/monthly_budget/delete/${j.budget_id}`;
                            if (actionsDiv) actionsDiv.style.display = 'block';
                        } else if (editLink && deleteLink) {
                            const getUrl = `/monthly_budget/get/${m}/${y}?_=${Date.now()}`;
                            try {
                                const r2 = await fetch(getUrl);
                                if (r2.ok) {
                                    const j2 = await r2.json();
                                    if (j2.budget_id) {
                                        editLink.href = `/monthly_budget/edit/${j2.budget_id}`;
                                        deleteLink.href = `/monthly_budget/delete/${j2.budget_id}`;
                                        if (actionsDiv) actionsDiv.style.display = 'block';
                                    }
                                }
                            } catch (e2) {
                                console.error('failed to fetch budget id', e2);
                            }
                        }

                    } catch (err) {
                        loading.textContent = 'Could not load monthly summary';
                        console.error('budget summary fetch error', err);
                    }
                }

                // wire up prev/go controls
                // use mutable references for currentMonth/currentYear
                let currentMonth = month;
                let currentYear = year;
                if (monthPicker) monthPicker.value = formatMonthPickerValue(currentYear, currentMonth);
                setAddLink(currentMonth, currentYear);

                prevBtn && prevBtn.addEventListener('click', function(){
                    // decrement month
                    let m = currentMonth;
                    let y = currentYear;
                    m -= 1;
                    if (m < 1) { m = 12; y -= 1; }
                    currentMonth = m; currentYear = y;
                    loadMonth(y, m);
                    // re-evaluate next button state
                    updateNextButton();
                });

                // change month on manual picker change
                monthPicker && monthPicker.addEventListener('change', function(){
                    const v = monthPicker.value;
                    if (!v) return;
                    const [yStr, mStr] = v.split('-');
                    const y2 = parseInt(yStr, 10);
                    const m2 = parseInt(mStr, 10);
                    const now = new Date();
                    const maxY = now.getFullYear();
                    const maxM = now.getMonth() + 1;
                    if (y2 > maxY || (y2 === maxY && m2 > maxM)) {
                        // clamp to current month
                        currentYear = maxY; currentMonth = maxM;
                        loadMonth(maxY, maxM);
                        updateNextButton();
                        return;
                    }
                    if (!isNaN(y2) && !isNaN(m2)) {
                        currentMonth = m2; currentYear = y2;
                        loadMonth(y2, m2);
                        updateNextButton();
                    }
                });

                // Next button handler (advance but not beyond current month)
                nextBtn && nextBtn.addEventListener('click', function(){
                    const now = new Date();
                    const maxY = now.getFullYear();
                    const maxM = now.getMonth() + 1;
                    let m = currentMonth;
                    let y = currentYear;
                    m += 1;
                    if (m > 12) { m = 1; y += 1; }
                    // clamp to current month/year
                    if (y > maxY || (y === maxY && m > maxM)) {
                        m = maxM; y = maxY;
                    }
                    currentMonth = m; currentYear = y;
                    loadMonth(y, m);
                    updateNextButton();
                });

                function updateNextButton(){
                    if (!nextBtn) return;
                    const now = new Date();
                    const maxY = now.getFullYear();
                    const maxM = now.getMonth() + 1;
                    if (currentYear > maxY || (currentYear === maxY && currentMonth >= maxM)){
                        nextBtn.disabled = true;
                    } else {
                        nextBtn.disabled = false;
                    }
                }

                // initial load for current month/year
                loadMonth(currentYear, currentMonth);
            })();
        </script>


    {# Search Form (hidden) #}
    {#
    <div>
        <form method="GET" action="{{ url_for('search') }}">
            <input type="text" name="category" placeholder="Search by category..." 
                   value="{{ search_category if search_category else '' }}">
            <input type="submit" value="Search">
            {% if search_category %}
                <a href="{{ url_for('home') }}">Clear Search</a>
            {% endif %}
        </form>
    </div>
    #}

    {# Add New Plan Form (hidden) #}
    {#
    <article class="plan new-plan">
        {% include 'new_plan_form.html' %}
    </article>
    #}

    {# Display Existing Plans (hidden) #}
    {#
    <div>
        <h3>Your Budget Plans</h3>
        {% for plan in plans %}
        <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
            <div>
                <a href="{{ url_for('edit', plan_id=plan._id)}}">Edit</a> | 
                <a href="{{ url_for('delete', plan_id=plan._id)}}">Delete</a>
            </div>
    
            <!-- title  -->
            <h4>{{ plan.title }} - {{ plan.category }}</h4>
    
            <!-- date -->
            <p><strong>Date:</strong> 
                {% if plan.day and plan.month and plan.year %}
                    {{ plan.day }}/{{ plan.month }}/{{ plan.year }}
                {% else %}
                    Not specified
                {% endif %}
            </p>
    
            <div>
                <strong>Planned:</strong> ${{ "%.2f"|format(plan.planned_expense) }} |
                <strong>Actual:</strong> ${{ "%.2f"|format(plan.actual_expense) }} |
                <strong>Difference:</strong> ${{ "%.2f"|format(plan.planned_expense - plan.actual_expense) }}
            </div>
    
            {% if plan.notes %}
            <p><strong>Notes:</strong> {{ plan.notes }}</p>
            {% endif %}
    
            <p><small>Created: {{ plan.created_at.strftime("%H:%M on %d %B %Y") }}</small></p>
        </div>
        {% endfor %}
    
    </div>
    #}

{% endblock %}